<html lang="ja">
<head>
  <meta charset="utf-8">

  <title>socket sample</title>
  <meta name="author" content="awisuw2">

  <script src="https://cdn.socket.io/socket.io-1.3.7.js"></script>
  <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
</head>

<script><!--
var SOCKETSTATUS = {
  NONE       : 0,
  CONNECT    : 1,
  DISCONNECT : 2,
  RECONNECT  : 3,
};
var SOCKETEVENT = {
  MESSAGE    : "message",
  MESSAGEALL : "messageall",
  TOCLIENT   : "message_toclient",
}

var socket;
var socket_status = SOCKETSTATUS.NONE;

$(function(){
  $('#msg').val("test msg : " + getRandomString(8));

  $('#connect').click(function(){
    connect();
  });

  // メッセージ送信
  $('#send').click(function(){
    if(canSendMessage()) {
      sendMessage(getMessage());
    } else {
      alert("please connect and set message");
    }
  });

  // 接続している全ユーザにメッセージ送信
  $('#sendall').click(function(){
    if(canSendMessage()) {
      sendMessageAll(getMessage());
    } else {
      alert("please connect and set message");
    }
  });
});

// 接続状況の更新
function changeState(status){
  socket_status = status;

  // statusの表示
  var msg = "none..";
  switch (status){
    case SOCKETSTATUS.NONE:
      msg = "none..";
      break;
    case SOCKETSTATUS.CONNECT:
      msg = "connect";
      break;
    case SOCKETSTATUS.DISCONNECT:
      msg = "disconnect";
      break;
    case SOCKETSTATUS.RECONNECT:
      msg = "reconnect";
      break;
  }
  $("#status").html(msg);
}

// 接続
function connect(){
  if(socket_status == SOCKETSTATUS.NONE){
    var host = $("#host").val();
    socket = io(host);
    socketInit();
  }
}

// メッセージを取得
function getMessage() {
  return $("#msg").val();
}

// メッセージを送れるか確認
function canSendMessage()
{
  if(socket_status == SOCKETSTATUS.CONNECT){
    if(getMessage()){
      return true;
    }
  }
  return false;
}

// メッセージ送信
function sendMessage(msg){
  socket.emit(SOCKETEVENT.MESSAGE, msg);
}
function sendMessageAll(msg){
  socket.emit(SOCKETEVENT.MESSAGEALL, msg);
}

// ランダム文字
function getRandomString(len) {
  var seed = "abcdefghijklmnopqrstuvwxyz0123456789";
  var l = seed.length;
  var r = "";
  for(var i=0; i<len; i++){
    r += seed[ Math.floor( Math.random()*l) ];
  }
  return r;
}

// ソケット初期化
function socketInit(){
  socket.on('connect', function(){
    changeState(SOCKETSTATUS.CONNECT);
  });
  socket.on('disconnect', function(){
    changeState(SOCKETSTATUS.DISCONNECT);
  });
  socket.on('reconnect', function(num){
    changeState(SOCKETSTATUS.RECONNECT);
  });
  socket.on('error', function(err){
    alert(err);
  });

  // custom event
  socket.on(SOCKETEVENT.TOCLIENT, function(msg){
    var msgs = $("#msgs").val();
    $("#msgs").val(msg + "\n" +msgs);
  });
}
--></script>
<body>
<h1>scoket connection test</h1>

<h2>step1:</h2>
<div>
<input id="host" type="text" value="">
<button id="connect">connect</button><br>
(例:192.168.33.10:3000 何も記述しない場合は、同ホスト)
<br>
<br>
status : <span id="status">none..</span>
</div>

<h2>step2:</h2>
<div>
<input id="msg" type="text" value="test message">
<button id="send">send</button>
<button id="sendall">sendall</button>
</div>

<textarea id="msgs" style="width: 500px; height: 200px;"></textarea>
<br>

</body>
</html>
